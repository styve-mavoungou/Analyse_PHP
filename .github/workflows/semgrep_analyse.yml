name: Analyse SAST avec Semgrep

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  semgrep_scan:
    name: Ex√©cuter Semgrep (analyse statique)
    runs-on: ubuntu-latest
    
    steps:
      # 1Ô∏è‚É£ Cloner le d√©p√¥t
      - name: üì¶ Cloner le d√©p√¥t
        uses: actions/checkout@v4
      
      # 2Ô∏è‚É£ Installer Semgrep
      - name: üß∞ Installer Semgrep
        run: pip install semgrep
      
      # 3Ô∏è‚É£ Ex√©cuter l'analyse (continuer m√™me si des vuln√©rabilit√©s sont trouv√©es)
      - name: üöÄ Lancer l'analyse Semgrep personnalis√©e
        id: semgrep
        continue-on-error: true
        run: |
          semgrep scan --config regles_vulnerabilites.yml --text --timeout 300 --no-git-ignore . > rapport_semgrep.txt 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
      
      # 4Ô∏è‚É£ Afficher le rapport dans la console
      - name: üìÑ Afficher le rapport
        if: always()
        run: |
          echo "=== RAPPORT D'ANALYSE SEMGREP ==="
          cat rapport_semgrep.txt || echo "Aucun rapport g√©n√©r√©"
      
      # 5Ô∏è‚É£ Sauvegarder le rapport
      - name: üì§ Sauvegarder le rapport d'analyse
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rapport-semgrep-${{ github.run_number }}
          path: rapport_semgrep.txt
          retention-days: 30
      
      # 6Ô∏è‚É£ Cr√©er un r√©sum√© des r√©sultats
      - name: üìä R√©sum√© de l'analyse
        if: always()
        run: |
          echo "## üìä R√©sum√© de l'analyse Semgrep" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Statut:** $([ "${{ steps.semgrep.outputs.exit_code }}" == "0" ] && echo '‚úÖ Aucune vuln√©rabilit√©' || echo '‚ö†Ô∏è Vuln√©rabilit√©s d√©tect√©es')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Nombre de vuln√©rabilit√©s:** $(grep -c 'severity:' rapport_semgrep.txt 2>/dev/null || echo '0')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì• T√©l√©chargez le rapport complet dans les artifacts" >> $GITHUB_STEP_SUMMARY
      
      # 7Ô∏è‚É£ √âchouer le job uniquement si des vuln√©rabilit√©s CRITIQUES sont trouv√©es
      - name: ‚ö†Ô∏è V√©rifier les vuln√©rabilit√©s critiques
        if: always()
        run: |
          if grep -q "severity: ERROR" rapport_semgrep.txt 2>/dev/null; then
            echo "‚ùå √âCHEC : Des vuln√©rabilit√©s CRITIQUES ont √©t√© d√©tect√©es !"
            echo "Veuillez corriger les vuln√©rabilit√©s avant de merger."
            exit 1
          else
            echo "‚úÖ Aucune vuln√©rabilit√© critique d√©tect√©e"
            exit 0
          fi
