name: ðŸ” Analyse DAST avec OWASP ZAP

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  zap_scan:
    name: ExÃ©cuter OWASP ZAP (avec Ngrok)
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ðŸŒ Lancer le serveur PHP local
        run: |
          php -S 127.0.0.1:8000 -t . > server.log 2>&1 &
          SERVER_PID=$!
          sleep 5
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          echo "âœ… Serveur PHP lancÃ© sur http://127.0.0.1:8000 (PID: $SERVER_PID)"
          
          # VÃ©rifier que le serveur rÃ©pond
          curl -v http://127.0.0.1:8000 || echo "âš ï¸ Le serveur ne rÃ©pond pas encore"

      - name: âš™ï¸ Installer et configurer Ngrok
        run: |
          # Installation de Ngrok
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar xzf ngrok-v3-stable-linux-amd64.tgz
          chmod +x ngrok
          
          # Configuration du token
          ./ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          
          # DÃ©marrage du tunnel
          ./ngrok http 8000 --log=stdout > ngrok.log 2>&1 &
          NGROK_PID=$!
          echo "NGROK_PID=$NGROK_PID" >> $GITHUB_ENV
          
          # Attendre que ngrok dÃ©marre
          echo "â³ Attente du dÃ©marrage de Ngrok..."
          sleep 15
          
          # RÃ©cupÃ©rer l'URL publique
          NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          # VÃ©rification
          if [ -z "$NGROK_URL" ] || [ "$NGROK_URL" = "null" ]; then
            echo "âŒ Erreur : Ngrok n'a pas dÃ©marrÃ© correctement."
            echo "ðŸ“‹ Logs Ngrok:"
            cat ngrok.log
            echo "ðŸ“‹ Logs serveur PHP:"
            cat server.log
            exit 1
          fi
          
          echo "âœ… Tunnel Ngrok actif : $NGROK_URL"
          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV
          
          # Test d'accÃ¨s
          curl -I "$NGROK_URL" || echo "âš ï¸ URL Ngrok non accessible"

      - name: ðŸ³ ExÃ©cuter OWASP ZAP
        continue-on-error: true
        id: zap_scan
        run: |
          echo "ðŸš€ Lancement du scan ZAP sur : ${{ env.NGROK_URL }}"
          
          # CrÃ©er le dossier de sortie
          mkdir -p ${{ github.workspace }}/zap-reports
          
          # TÃ©lÃ©charger l'image Docker
          docker pull ghcr.io/zaproxy/zaproxy:stable
          
          # ExÃ©cuter le scan ZAP
          docker run --rm \
            --network host \
            -v ${{ github.workspace }}/zap-reports:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t "${{ env.NGROK_URL }}" \
            -r zap-report.html \
            -w zap-report.md \
            -J zap-report.json \
            -I
          
          echo "scan_completed=true" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Afficher les rÃ©sultats
        if: always()
        run: |
          echo "ðŸ“ Contenu du dossier de rapports:"
          ls -lah ${{ github.workspace }}/zap-reports/ || echo "Aucun fichier trouvÃ©"
          
          if [ -f "${{ github.workspace }}/zap-reports/zap-report.html" ]; then
            echo "âœ… Rapport HTML gÃ©nÃ©rÃ©"
          else
            echo "âŒ Pas de rapport HTML"
          fi

      - name: ðŸ“¦ Upload des rapports ZAP
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-security-report
          path: ${{ github.workspace }}/zap-reports/
          if-no-files-found: warn

      - name: ðŸ§¹ Nettoyage
        if: always()
        run: |
          # ArrÃªter Ngrok
          kill ${{ env.NGROK_PID }} 2>/dev/null || true
          
          # ArrÃªter le serveur PHP
          kill ${{ env.SERVER_PID }} 2>/dev/null || true
          
          echo "âœ… Processus arrÃªtÃ©s"

      - name: ðŸ“ RÃ©sumÃ©
        if: always()
        run: |
          echo "## ðŸ” RÃ©sumÃ© du scan OWASP ZAP" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **URL scannÃ©e:** ${{ env.NGROK_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan terminÃ©:** ${{ steps.zap_scan.outputs.scan_completed || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **TÃ©lÃ©chargez le rapport** dans la section 'Artifacts' ci-dessous" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "${{ github.workspace }}/zap-reports/zap-report.md" ]; then
            echo "### AperÃ§u des alertes" >> $GITHUB_STEP_SUMMARY
            head -n 50 "${{ github.workspace }}/zap-reports/zap-report.md" >> $GITHUB_STEP_SUMMARY || true
          fi
