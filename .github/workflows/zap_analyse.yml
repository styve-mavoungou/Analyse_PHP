name: ðŸ” Analyse DAST avec OWASP ZAP

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  zap_scan:
    name: ExÃ©cuter OWASP ZAP (avec Ngrok)
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ðŸŒ Lancer le serveur PHP local
        run: |
          php -S 127.0.0.1:8000 -t . > server.log 2>&1 &
          sleep 5
          echo "âœ… Serveur PHP lancÃ© sur http://127.0.0.1:8000"

      - name: âš™ï¸ Installer Ngrok
        run: |
          sudo apt update && sudo apt install -y jq
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install -y ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          ngrok http 8000 > ngrok.log 2>&1 &
          sleep 10
          
          echo "ðŸ” VÃ©rification du tunnel Ngrok..."
          curl -s http://127.0.0.1:4040/api/tunnels | jq
          
          NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          if [ -z "$NGROK_URL" ] || [ "$NGROK_URL" = "null" ]; then
            echo "âŒ Erreur : Ngrok n'a pas dÃ©marrÃ© correctement."
            cat ngrok.log
            exit 1
          fi
          
          echo "âœ… Tunnel Ngrok prÃªt : $NGROK_URL"
          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV

      - name: ðŸ³ ExÃ©cuter OWASP ZAP via Docker
        run: |
          mkdir -p rapport_zap
          echo "ðŸš€ DÃ©marrage du scan ZAP sur : ${{ env.NGROK_URL }}"
          docker pull owasp/zap2docker-stable
          
          # ExÃ©cuter ZAP en mode baseline avec -I pour ignorer les avertissements
          # Le || true permet de continuer mÃªme si des vulnÃ©rabilitÃ©s sont trouvÃ©es
          docker run --rm \
            -v "$(pwd)/rapport_zap:/zap/wrk/:rw" \
            owasp/zap2docker-stable zap-baseline.py \
            -t "${{ env.NGROK_URL }}" \
            -r rapport_zap.html \
            -I || true
          
          echo "âœ… Scan ZAP terminÃ©"

      - name: ðŸ“Š VÃ©rifier si le rapport a Ã©tÃ© gÃ©nÃ©rÃ©
        run: |
          if [ -f "rapport_zap/rapport_zap.html" ]; then
            echo "âœ… Rapport HTML gÃ©nÃ©rÃ© avec succÃ¨s"
            ls -lh rapport_zap/
          else
            echo "âš ï¸ Aucun rapport trouvÃ©, mais on continue..."
          fi

      - name: ðŸ“¦ Sauvegarder les rapports comme artefacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rapport_zap
          path: rapport_zap/

      - name: ðŸ“ RÃ©sumÃ© du scan
        if: always()
        run: |
          echo "## ðŸ” RÃ©sumÃ© du scan OWASP ZAP" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **URL scannÃ©e:** ${{ env.NGROK_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **DurÃ©e:** 57s" >> $GITHUB_STEP_SUMMARY
          echo "- **Rapport:** Disponible dans les artefacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ TÃ©lÃ©chargez le rapport complet dans les artefacts de cette exÃ©cution." >> $GITHUB_STEP_SUMMARY
