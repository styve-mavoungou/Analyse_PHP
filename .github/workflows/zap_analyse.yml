name: ğŸ” Analyse DAST avec OWASP ZAP

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  zap_scan:
    name: ExÃ©cuter OWASP ZAP (avec Ngrok)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ”§ Configurer PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'

      - name: ğŸŒ Lancer le serveur PHP local
        run: |
          nohup php -S 127.0.0.1:8000 -t . > server.log 2>&1 &
          echo "âœ… Serveur PHP lancÃ© sur http://127.0.0.1:8000"
          sleep 3
          # VÃ©rifier que le serveur rÃ©pond
          curl -f http://127.0.0.1:8000 || echo "âš ï¸ Serveur PHP pas encore prÃªt"

      - name: âš™ï¸ Installer Ngrok
        run: |
          sudo apt update && sudo apt install -y jq
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install -y ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          nohup ngrok http 8000 --log=stdout > ngrok.log 2>&1 &
          echo "â³ Attente du dÃ©marrage de Ngrok..."
          sleep 15
          
          # VÃ©rifier le tunnel Ngrok
          echo "ğŸ” VÃ©rification du tunnel Ngrok..."
          MAX_RETRIES=10
          RETRY_COUNT=0
          NGROK_URL=""
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            sleep 5
            RESPONSE=$(curl -s http://127.0.0.1:4040/api/tunnels || echo "{}")
            NGROK_URL=$(echo $RESPONSE | jq -r '.tunnels[0].public_url // "null"')
            
            if [ "$NGROK_URL" != "null" ] && [ ! -z "$NGROK_URL" ]; then
              echo "âœ… Tunnel Ngrok prÃªt : $NGROK_URL"
              echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT+1))
            echo "â±ï¸  Tentative $RETRY_COUNT/$MAX_RETRIES - Ngrok pas encore prÃªt..."
          done
          
          if [ -z "$NGROK_URL" ] || [ "$NGROK_URL" = "null" ]; then
            echo "âŒ Erreur : Ngrok n'a pas dÃ©marrÃ© correctement aprÃ¨s $MAX_RETRIES tentatives"
            echo "ğŸ“„ Logs Ngrok :"
            cat ngrok.log
            echo "ğŸ“„ Logs serveur :"
            cat server.log
            exit 1
          fi

      - name: ğŸ” VÃ©rifier l'accessibilitÃ© de l'application
        run: |
          echo "ğŸŒ Test d'accÃ¨s Ã  l'application via Ngrok..."
          curl -f "${{ env.NGROK_URL }}" && echo "âœ… Application accessible via Ngrok" || echo "âŒ Application inaccessible via Ngrok"

      - name: ğŸ³ ExÃ©cuter OWASP ZAP via Docker
        run: |
          mkdir -p rapport_zap
          echo "ğŸš€ DÃ©marrage du scan ZAP sur : ${{ env.NGROK_URL }}"
          
          # Scan principal avec gÃ©nÃ©ration de rapport HTML
          docker run --rm \
            -v "$(pwd)/rapport_zap:/zap/wrk/:rw" \
            -t owasp/zap2docker-stable zap-baseline.py \
            -t "${{ env.NGROK_URL }}" \
            -c zap-config.conf \
            -r rapport_zap.html \
            -I \
            -j \
            -m 5 || echo "âš ï¸ Scan ZAP terminÃ© avec des alertes (statut non-zero)"
          
          echo "ğŸ“Š Scan ZAP terminÃ©"

      - name: ğŸ“Š GÃ©nÃ©rer rapport texte supplÃ©mentaire
        run: |
          echo "ğŸ“ GÃ©nÃ©ration du rapport texte..."
          docker run --rm \
            -v "$(pwd)/rapport_zap:/zap/wrk/:rw" \
            -t owasp/zap2docker-stable zap-baseline.py \
            -t "${{ env.NGROK_URL }}" \
            -c zap-config.conf \
            -w rapport_zap.txt \
            -I || true

      - name: ğŸ“¦ Sauvegarder les rapports comme artefacts
        uses: actions/upload-artifact@v4
        with:
          name: rapport_zap
          path: rapport_zap/
          retention-days: 7

      - name: ğŸ“„ Afficher un rÃ©sumÃ©
        run: |
          echo "ğŸ“‹ RÃ©sumÃ© de l'analyse ZAP"
          if [ -f "rapport_zap/rapport_zap.html" ]; then
            echo "âœ… Rapport HTML gÃ©nÃ©rÃ© avec succÃ¨s"
          else
            echo "âŒ Rapport HTML non gÃ©nÃ©rÃ©"
          fi
          if [ -f "rapport_zap/rapport_zap.txt" ]; then
            echo "ğŸ“„ Contenu du rapport texte :"
            head -50 rapport_zap/rapport_zap.txt || echo "Rapport texte vide ou inaccessible"
          fi
