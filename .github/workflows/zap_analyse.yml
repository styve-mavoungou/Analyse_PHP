name: ğŸ” OWASP ZAP Scan

on: [push, pull_request]

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ³ CrÃ©er rÃ©seau Docker
        run: docker network create scan-network
      
      - name: ğŸŒ Lancer application PHP
        run: |
          docker run -d \
            --name php-app \
            --network scan-network \
            -v $(pwd):/var/www/html \
            -w /var/www/html \
            php:8.2-cli \
            php -S 0.0.0.0:8000 -t .
          
          sleep 5
          echo "âœ… Application PHP dÃ©marrÃ©e"
      
      - name: ğŸ” Scanner avec OWASP ZAP
        run: |
          mkdir -p zap-output
          
          echo "ğŸš€ DÃ©marrage du scan..."
          
          docker run --rm \
            --network scan-network \
            -v $(pwd)/zap-output:/zap/wrk/:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://php-app:8000 \
            -r report.html \
            -w report.md \
            -J report.json \
            -I || true
          
          echo "âœ… Scan terminÃ©"
      
      - name: ğŸ“„ Convertir le rapport Markdown en TXT
        if: always()
        run: |
          if [ -f "zap-output/report.md" ]; then
            # Copier le markdown comme txt (le markdown est dÃ©jÃ  du texte lisible)
            cp zap-output/report.md zap-output/report.txt
            echo "âœ… Rapport TXT crÃ©Ã©"
          else
            echo "âš ï¸ Pas de rapport Markdown Ã  convertir"
          fi
      
      - name: ğŸ“Š VÃ©rifier les rapports
        if: always()
        run: |
          echo "ğŸ“ Rapports gÃ©nÃ©rÃ©s:"
          ls -lh zap-output/
          
          echo ""
          echo "ğŸ“‹ Formats disponibles:"
          [ -f "zap-output/report.html" ] && echo "âœ… HTML - Rapport visuel complet"
          [ -f "zap-output/report.md" ] && echo "âœ… Markdown - Format structurÃ©"
          [ -f "zap-output/report.json" ] && echo "âœ… JSON - DonnÃ©es brutes"
          [ -f "zap-output/report.txt" ] && echo "âœ… TXT - Texte brut"
      
      - name: ğŸ“¦ Sauvegarder les rapports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-security-reports
          path: zap-output/
          if-no-files-found: warn
      
      - name: ğŸ“ RÃ©sumÃ© dans GitHub Actions
        if: always()
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## ğŸ” RÃ©sultats du scan OWASP ZAP
          
          ### ğŸ“¦ Rapports disponibles:
          - **report.html** - Rapport complet avec interface visuelle
          - **report.md** - Rapport en Markdown
          - **report.json** - DonnÃ©es JSON pour automatisation
          - **report.txt** - Rapport en texte brut
          
          ### ğŸ“¥ Comment tÃ©lÃ©charger:
          1. Cliquez sur "Summary" en haut de page
          2. Descendez jusqu'Ã  "Artifacts"
          3. TÃ©lÃ©chargez "zap-security-reports"
          4. DÃ©compressez l'archive
          
          EOF
          
          if [ -f "zap-output/report.md" ]; then
            echo "### ğŸ“‹ AperÃ§u des vulnÃ©rabilitÃ©s:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 50 zap-output/report.md >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ§¹ Nettoyage
        if: always()
        run: |
          docker stop php-app 2>/dev/null || true
          docker rm php-app 2>/dev/null || true
          docker network rm scan-network 2>/dev/null || true
          echo "âœ… Nettoyage terminÃ©"
